FROM php:8.1.9-apache

ARG PHP_VERSION="8.1"
ENV PHP_VERSION="${PHP_VERSION}"
ARG SERVERNAME="localhost"

RUN echo "ServerName 127.0.0.1" >> /etc/apache2/apache2.conf


ARG USER="useradmin"

RUN \
    DEBIAN_FRONTEND=noninteractive \
    apt-get update && \
    apt-get -y upgrade

RUN apt-get -y install --fix-missing sudo \
    gpg \
    vim \
    wget \
    git \
    software-properties-common

RUN apt-get update && \
    apt-get -y upgrade

RUN apt-get -y install --fix-missing curl
RUN apt-get -y install --fix-missing git
RUN apt-get -y install --fix-missing zip unzip


RUN apt-get install --fix-missing -y libpq-dev
RUN apt-get install --no-install-recommends -y libpq-dev
RUN apt-get install -y libxml2-dev libbz2-dev zlib1g-dev

RUN apt-get install --fix-missing -y libsqlite3-dev \
    libsqlite3-0 \
    exif \
    ftp \
    ntp \
    gdal-bin

ADD https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/
RUN chmod +x /usr/local/bin/install-php-extensions && \
    install-php-extensions \
    curl fileinfo gd mbstring mysqli intl openssl pdo_mysql

RUN apt-get -y install --fix-missing --no-install-recommends \
    mariadb-client 

COPY docker/apache/000-default.conf /etc/apache2/sites-available/000-default.conf


COPY --from=composer:latest /usr/bin/composer /usr/bin/composer
RUN composer self-update 

#ENV APACHE_DOCUMENT_ROOT /var/www/html/codeigniter4/public
RUN  apt-get update && apt-get install -y ca-certificates gnupg
RUN curl -fsSL https://deb.nodesource.com/setup_16.x | bash -

#RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf
#RUN sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf
RUN /usr/sbin/a2enmod rewrite && /usr/sbin/a2enmod headers && /usr/sbin/a2enmod expires
RUN apt-get update && apt-get install -y libzip-dev zip && docker-php-ext-install zip
RUN docker-php-ext-install pdo pdo_mysql mysqli
RUN apt-get install -y libtidy-dev 

RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
# RUN apt-get install php8.1-xdebug

# RUN echo 'zend_extension=xdebug' >> /usr/local/etc/php/php.ini
# RUN echo 'xdebug.mode=develop,debug' >> /usr/local/etc/php/php.ini
# RUN echo 'xdebug.client_host=host.docker.internal' >> /usr/local/etc/php/php.ini
# RUN echo 'xdebug.start_with_request=trigger' >> /usr/local/etc/php/php.ini
# RUN echo 'xdebug.client_port=9003' >> /usr/local/etc/php/php.ini
# RUN echo 'session.save_path = "/tmp"' >> /usr/local/etc/php/php.ini

# RUN groupadd -r ${USER} && useradd -g ${USER} ${USER}

RUN apt-get clean && rm -r /var/lib/apt/lists/* \
    &&  rm -rf \
    /tmp/* \
    /root/.cache

RUN a2enmod rewrite headers

COPY ./ /var/www/html/

RUN composer install

EXPOSE 8080
EXPOSE 443